<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ–éŸ³è¯„è®ºåŒºæ¨¡æ‹Ÿ</title>
    <style>
        :root {
            --bg-color: #161823;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.5);
            --accent-color: #fe2c55;
            --item-bg: #252732;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            font-weight: bold;
        }

        /* è¯„è®ºåˆ—è¡¨åŒº */
        .comment-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .comment-item {
            margin-bottom: 20px;
            display: flex;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
            cursor: pointer;
        }

        .comment-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .comment-item.active {
            background: rgba(255, 255, 255, 0.08) !important;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #444;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .content-box {
            flex: 1;
        }

        .nickname {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }

        .author-tag {
            background-color: var(--accent-color);
            color: white;
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 2px;
            margin-left: 5px;
        }

        .comment-text {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .comment-info {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            gap: 15px;
        }

        .like-btn {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .like-btn.active {
            color: var(--accent-color);
        }

        /* å›å¤åŒº */
        .replies {
            margin-top: 10px;
            margin-left: 52px;
            border-left: 2px solid rgba(255, 255, 255, 0.05);
            padding-left: 10px;
        }

        .reply-item {
            margin-bottom: 15px;
            display: flex;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .reply-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .view-more {
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            margin-top: 8px;
            display: inline-block;
        }

        /* åº•éƒ¨è¾“å…¥æ¡† */
        .input-area {
            padding: 15px;
            background-color: var(--item-bg);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            color: white;
            outline: none;
        }

        .send-btn {
            color: var(--accent-color);
            font-weight: bold;
            cursor: pointer;
        }

        /* å³é”®èœå•æ ·å¼ */
        .context-menu {
            position: fixed;
            background: #252732;
            border-radius: 8px;
            padding: 5px 0;
            min-width: 140px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.8);
            z-index: 1000;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-item {
            padding: 12px 15px;
            font-size: 14px;
            cursor: pointer;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item.disabled {
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }

        .menu-item:hover:not(.disabled) {
            background: rgba(255, 255, 255, 0.1);
        }

        .menu-item.delete {
            color: #fe2c55;
        }

        /* æ­£åœ¨å›å¤çŠ¶æ€æ  */
        .reply-bar {
            background: rgba(254, 44, 85, 0.1);
            padding: 5px 15px;
            font-size: 12px;
            color: var(--accent-color);
            display: none;
            justify-content: space-between;
            align-items: center;
        }

        .close-reply {
            cursor: pointer;
            font-size: 16px;
        }
        /* ç™»å½•æ æ ·å¼ */
        .login-section {
            padding: 15px;
            background: var(--item-bg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .login-btn {
            background: var(--accent-color);
            color: white;
            padding: 6px 15px;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .logout-link {
            color: var(--text-secondary);
            font-size: 12px;
            text-decoration: underline;
            cursor: pointer;
        }

        /* ç™»å½•å¼¹çª— */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: var(--item-bg);
            padding: 30px;
            border-radius: 12px;
            width: 300px;
            text-align: center;
        }

        .modal-content input {
            width: 80%;
            margin: 20px 0;
            background: rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="login-section" id="loginSection">
            <!-- åŠ¨æ€æ˜¾ç¤ºç™»å½•çŠ¶æ€ -->
        </div>
        <div class="header">è¯„è®ºåŒº</div>
        
        <div class="comment-list" id="commentList">
            <!-- åŠ¨æ€åŠ è½½ -->
        </div>

        <div id="replyBar" class="reply-bar">
            <span id="replyInfo">æ­£åœ¨å›å¤ @ç”¨æˆ·...</span>
            <span class="close-reply" onclick="cancelReply()">Ã—</span>
        </div>

        <div class="input-area">
            <input type="text" id="commentInput" placeholder="å–„è¯­ç»“å–„ç¼˜ï¼Œæ¶è¯­ä¼¤äººå¿ƒ">
            <div class="send-btn" onclick="sendComment()">å‘å¸ƒ</div>
        </div>
    </div>

    <!-- ç™»å½•å¼¹çª— -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h3>æ¨¡æ‹Ÿç™»å½•</h3>
            <p style="font-size: 12px; color: gray;">è¾“å…¥ MySQL ä¸­å·²æœ‰çš„ User ID</p>
            <input type="number" id="loginUserId" placeholder="User ID (å¦‚: 1)">
            <div class="login-btn" onclick="handleLogin()">ç¡®å®šç™»å½•</div>
            <p style="font-size: 12px; margin-top: 15px; cursor: pointer;" onclick="toggleLoginModal(false)">å–æ¶ˆ</p>
        </div>
    </div>

    <!-- å³é”®èœå• -->
    <div id="contextMenu" class="context-menu">
        <div id="deleteMenuItem" class="menu-item delete">ğŸ—‘ï¸ åˆ é™¤è¯„è®º</div>
        <div class="menu-item" onclick="handleCopy()">ğŸ“‹ å¤åˆ¶å†…å®¹</div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8888/api/v1';
        const VIDEO_ID = 1001;
        
        let USER_ID = 0; 
        let AUTH_TOKEN = localStorage.getItem('token') || '';

        let replyingToId = 0; 
        let replyingToRootId = 0; 
        let selectedCommentId = 0; 
        let selectedCommentUserId = 0; 
        
        const expandedRootIds = new Set();

        // æ ¸å¿ƒè¯·æ±‚å°è£…ï¼šè‡ªåŠ¨å¸¦ä¸Š JWT
        async function apiFetch(url, options = {}) {
            options.headers = options.headers || {};
            if (AUTH_TOKEN) {
                options.headers['Authorization'] = AUTH_TOKEN;
            }
            const res = await fetch(url, options);
            if (res.status === 401) {
                alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                logout();
                throw new Error('Unauthorized');
            }
            return res;
        }

        // åˆå§‹åŒ–ç™»å½•çŠ¶æ€
        function initAuth() {
            const savedUserId = localStorage.getItem('userId');
            if (savedUserId && AUTH_TOKEN) {
                USER_ID = parseInt(savedUserId);
                renderLoginSection(true);
            } else {
                renderLoginSection(false);
            }
        }

        function renderLoginSection(isLoggedIn) {
            const section = document.getElementById('loginSection');
            if (isLoggedIn) {
                section.innerHTML = `
                    <div class="user-info">ğŸ‘¤ å½“å‰ç”¨æˆ· ID: ${USER_ID}</div>
                    <div class="logout-link" onclick="logout()">é€€å‡ºç™»å½•</div>
                `;
            } else {
                section.innerHTML = `
                    <div style="font-size: 14px; color: gray;">æœªç™»å½• (åªèƒ½æŸ¥çœ‹)</div>
                    <div class="login-btn" onclick="toggleLoginModal(true)">ç™»å½•/åˆ‡æ¢è´¦å·</div>
                `;
            }
        }

        function toggleLoginModal(show) {
            document.getElementById('loginModal').style.display = show ? 'flex' : 'none';
        }

        async function handleLogin() {
            const uid = document.getElementById('loginUserId').value;
            if (!uid) return;

            try {
                const res = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: parseInt(uid) })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    AUTH_TOKEN = data.token;
                    USER_ID = parseInt(uid);
                    localStorage.setItem('token', AUTH_TOKEN);
                    localStorage.setItem('userId', USER_ID);
                    toggleLoginModal(false);
                    renderLoginSection(true);
                    loadComments(); // åˆ·æ–°ä»¥æ›´æ–°ç‚¹èµçŠ¶æ€
                } else {
                    alert('ç™»å½•å¤±è´¥ï¼Œè¯·ç¡®ä¿ User ID åœ¨æ•°æ®åº“ä¸­å­˜åœ¨');
                }
            } catch (err) {
                alert('ç™»å½•è¯·æ±‚å¤±è´¥');
            }
        }

        function logout() {
            AUTH_TOKEN = '';
            USER_ID = 0;
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            renderLoginSection(false);
            loadComments();
        }

        // åˆå§‹åŠ è½½è¯„è®º
        async function loadComments(preserveScroll = true) {
            const list = document.getElementById('commentList');
            const scrollPos = list.scrollTop; 

            try {
                // è·å–è¯„è®ºåˆ—è¡¨æ— éœ€ JWTï¼Œä½†ä¼ å…¥ user_id å¯åˆ¤æ–­ç‚¹èµçŠ¶æ€
                const res = await fetch(`${API_BASE}/comments?video_id=${VIDEO_ID}&user_id=${USER_ID}&page=1&page_size=50`);
                const data = await res.json();
                await renderComments(data.comments); 
                document.querySelector('.header').innerText = `è¯„è®º (${data.total || 0})`;
                
                if (preserveScroll) {
                    requestAnimationFrame(() => {
                        list.scrollTop = scrollPos;
                    });
                }
            } catch (err) {
                console.error('åŠ è½½å¤±è´¥', err);
            }
        }

        function getAvatarStyle(url) {
            const fallback = 'https://p3-passthrough.byteimg.com/img/mosaic-legacy/3795/3047680722~120x120.image'; // é»˜è®¤å ä½
            // å¦‚æœåŸæ¥çš„ URL åŠ è½½å¤±è´¥ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ UI å­—ç¬¦å¤´åƒä½œä¸ºæœ€ç»ˆå…œåº•
            return `background-image: url('${url}'), url('https://ui-avatars.com/api/?name=User&background=random'); background-size: cover;`;
        }

        async function renderComments(comments) {
            const list = document.getElementById('commentList');
            list.innerHTML = ''; 

            if (!comments || comments.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:gray;padding:20px;">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</div>';
                return;
            }

            for (const item of comments) {
                const c = item.comment;
                const commentHtml = `
                    <div class="comment-item" id="comment-${c.id}"
                         oncontextmenu="showContextMenu(event, ${c.id}, ${c.user_id})"
                         onclick="startReply(${c.id}, '${c.nickname}', ${c.root_id || c.id})">
                        <div class="avatar" style="${getAvatarStyle(c.avatar)}"></div>
                        <div class="content-box">
                            <div class="nickname">${c.nickname} ${c.is_author ? '<span class="author-tag">ä½œè€…</span>' : ''}</div>
                            <div class="comment-text">${c.content}</div>
                            <div class="comment-info">
                                <span>${c.created_at}</span>
                                <span>${c.ip_location || 'æœªçŸ¥'}</span>
                                <div class="like-btn ${c.is_liked ? 'active' : ''}" onclick="event.stopPropagation(); toggleLike(${c.id}, ${c.is_liked})">
                                    ${c.is_liked ? 'â¤ï¸' : 'ğŸ¤'} ${formatCount(c.like_count)}
                                </div>
                            </div>
                            
                            ${(item.reply_total > 0 || expandedRootIds.has(c.id)) ? `
                                <div class="replies" id="replies-${c.id}">
                                    ${expandedRootIds.has(c.id) 
                                        ? '<div style="padding: 10px; color: gray; font-size: 12px;">æ­£åœ¨åŠ è½½å›å¤...</div>' 
                                        : `<div class="view-more" onclick="event.stopPropagation(); loadReplies(${c.id})">â€”â€” å±•å¼€ ${item.reply_total} æ¡å›å¤ âˆ¨</div>`
                                    }
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', commentHtml);
                
                if (expandedRootIds.has(c.id)) {
                    loadReplies(c.id);
                }
            }
        }

        function startReply(id, nickname, rootId) {
            if (!USER_ID) {
                toggleLoginModal(true);
                return;
            }
            document.querySelectorAll('.comment-item, .reply-item').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(`comment-${id}`) || event.currentTarget;
            if (target) target.classList.add('active');

            replyingToId = id;
            replyingToRootId = rootId;

            const input = document.getElementById('commentInput');
            input.placeholder = `å›å¤ @${nickname}ï¼š`;
            input.focus();
            
            document.getElementById('replyBar').style.display = 'flex';
            document.getElementById('replyInfo').innerText = `æ­£åœ¨å›å¤ @${nickname}`;
        }

        function cancelReply() {
            replyingToId = 0;
            replyingToRootId = 0;
            const input = document.getElementById('commentInput');
            input.placeholder = "å–„è¯­ç»“å–„ç¼˜ï¼Œæ¶è¯­ä¼¤äººå¿ƒ";
            document.getElementById('replyBar').style.display = 'none';
            document.querySelectorAll('.comment-item, .reply-item').forEach(el => el.classList.remove('active'));
        }

        function showContextMenu(e, id, userId) {
            e.preventDefault();
            e.stopPropagation();
            
            selectedCommentId = id;
            selectedCommentUserId = userId;

            document.querySelectorAll('.comment-item, .reply-item').forEach(el => el.classList.remove('active'));
            e.currentTarget.classList.add('active');

            const menu = document.getElementById('contextMenu');
            const deleteBtn = document.getElementById('deleteMenuItem');

            const newDeleteBtn = deleteBtn.cloneNode(true);
            deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);

            if (userId !== USER_ID) {
                newDeleteBtn.classList.add('disabled');
                newDeleteBtn.style.opacity = '0.5';
            } else {
                newDeleteBtn.classList.remove('disabled');
                newDeleteBtn.style.opacity = '1';
                newDeleteBtn.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    handleDelete();
                });
            }

            let x = e.clientX;
            let y = e.clientY;
            const menuWidth = 150;
            const menuHeight = 100;
            if (x + menuWidth > window.innerWidth) x -= menuWidth;
            if (y + menuHeight > window.innerHeight) y -= menuHeight;
            
            menu.style.display = 'block';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
        }

        async function handleDelete() {
            if (!USER_ID) return;
            if (!selectedCommentId) return;

            const isConfirmed = window.confirm('âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦å½»åº•åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ\nåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚');
            
            if (isConfirmed) {
                try {
                    const res = await apiFetch(`${API_BASE}/comment`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            comment_id: parseInt(selectedCommentId),
                            user_id: USER_ID
                        })
                    });
                    
                    if (res.ok) {
                        document.getElementById('contextMenu').style.display = 'none';
                        loadComments();
                    }
                } catch (err) {
                    console.error('Delete error:', err);
                }
            }
        }

        async function sendComment() {
            if (!USER_ID) {
                toggleLoginModal(true);
                return;
            }
            const input = document.getElementById('commentInput');
            const content = input.value.trim();
            if (!content) return;

            try {
                const isReply = replyingToRootId > 0;
                if (isReply) {
                    expandedRootIds.add(replyingToRootId);
                }

                const res = await apiFetch(`${API_BASE}/comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        video_id: VIDEO_ID,
                        user_id: USER_ID,
                        content: content,
                        parent_id: replyingToId
                    })
                });
                
                if (res.ok) {
                    input.value = '';
                    loadComments(isReply); 
                    setTimeout(cancelReply, 1000); 
                }
            } catch (err) {
                alert('å‘å¸ƒå¤±è´¥');
            }
        }

        async function loadReplies(rootId) {
            expandedRootIds.add(rootId);
            try {
                const res = await fetch(`${API_BASE}/comments?video_id=${VIDEO_ID}&user_id=${USER_ID}&root_id=${rootId}&page=1&page_size=50`);
                const data = await res.json();
                renderSubComments(rootId, data.comments);
            } catch (err) {
                console.error('åŠ è½½å­è¯„è®ºå¤±è´¥', err);
            }
        }

        function renderSubComments(rootId, comments) {
            const container = document.getElementById(`replies-${rootId}`);
            if (!container) return;
            
            container.innerHTML = ''; 
            
            comments.forEach(item => {
                const c = item.comment;
                const html = `
                    <div class="reply-item" 
                         oncontextmenu="showContextMenu(event, ${c.id}, ${c.user_id})"
                         onclick="event.stopPropagation(); startReply(${c.id}, '${c.nickname}', ${rootId})">
                        <div class="avatar" style="width: 24px; height: 24px; ${getAvatarStyle(c.avatar)}"></div>
                        <div class="content-box">
                            <div class="nickname">${c.nickname}</div>
                            <div class="comment-text">
                                ${c.reply_to_name ? `<span style="color: gray; font-size: 14px;">å›å¤ <span style="color: #61b1ff;">@${c.reply_to_name}</span>ï¼š</span>` : ''}
                                ${c.content}
                            </div>
                            <div class="comment-info">
                                <span>${c.created_at}</span>
                                <span>${c.ip_location || 'æœªçŸ¥'}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
            
            container.insertAdjacentHTML('beforeend', `<div class="view-more" onclick="event.stopPropagation(); closeReplies(${rootId})">â€”â€” æ”¶èµ·å›å¤ âˆ§</div>`);
        }

        function closeReplies(rootId) {
            expandedRootIds.delete(rootId);
            loadComments();
        }

        async function handleCopy() {
            const activeItem = document.querySelector('.comment-item.active, .reply-item.active');
            if (activeItem) {
                const text = activeItem.querySelector('.comment-text').innerText;
                try {
                    await navigator.clipboard.writeText(text);
                    alert('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (err) {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('å†…å®¹å·²å¤åˆ¶');
                }
            }
            document.getElementById('contextMenu').style.display = 'none';
        }

        function formatCount(count) {
            if (count >= 10000) return (count / 10000).toFixed(1) + 'w';
            return count;
        }

        async function toggleLike(commentId, isLiked) {
            if (!USER_ID) {
                toggleLoginModal(true);
                return;
            }
            try {
                await apiFetch(`${API_BASE}/comment/like`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        comment_id: commentId,
                        user_id: USER_ID,
                        action: isLiked ? 0 : 1
                    })
                });
                loadComments();
            } catch (err) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        document.addEventListener('click', (e) => {
            const menu = document.getElementById('contextMenu');
            if (menu.style.display === 'block') {
                menu.style.display = 'none';
                if (replyingToId === 0) {
                    document.querySelectorAll('.comment-item, .reply-item').forEach(el => el.classList.remove('active'));
                }
            }
        });

        initAuth();
        window.onload = loadComments;
    </script>
</body>
</html>
